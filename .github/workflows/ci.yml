name: CI

on:
  pull_request:
    branches:
      - master
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}  # ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãªã„ãŸã‚ PR ãƒ¬ãƒ™ãƒ«ã®æ’ä»–åˆ¶å¾¡
  cancel-in-progress: true # PR ã®æ›´æ–°ãŒã‚ã£ãŸå ´åˆã¯å‰ã®ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹

permissions:
  contents: read
  pull-requests: write

jobs:
  documentation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: aquaproj/aqua-installer@d1fe50798dbadd4eb5b98957290ca175f6b4870f # v4.0.2
        with:
          aqua_version: v2.53.7

      - run: github-comment exec -- github-comment hide
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 #v4.4.0
        with:
          node-version: '20'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli2

      - name: Lint Markdown Files
        run: github-comment exec -k common-error -var title:"Check Markdown Failed" -- markdownlint-cli2 "**/*.md" --config ".markdownlint.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-scan:
    needs: documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: aquaproj/aqua-installer@d1fe50798dbadd4eb5b98957290ca175f6b4870f # v4.0.2
        with:
          aqua_version: v2.53.7

      - name: Setup PHP
        uses: shivammathur/setup-php@ccf2c627fe61b1b4d924adfcbd19d661a18133a0 #v2.35.2
        with:
          php-version: '8.1'
          extensions: pdo, pdo_sqlite
          tools: composer

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Security audit
        run: |
          # Composerã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
          composer audit

      - name: Check for sensitive files
        run: |
          # æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
          if [ -f "config/config.php" ]; then
            echo "Error: config.php should not be committed"
            github-comment post -k common-error -var title:"Check Sensitive Files Exists" -var body:"Error: config.php should not be committed"
            exit 1
          fi

          # .envãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
          if [ -f ".env" ]; then
            echo "Error: .env should not be committed"
            github-comment post -k common-error -var title:"Check Sensitive Files Exists" -var body:"Error: .env should not be committed"
            exit 1
          fi

          echo "âœ… No sensitive files found"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  lint-and-test:
    needs: documentation
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        php-version:
          - '8.1'
          - '8.2'
          - '8.3'

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: aquaproj/aqua-installer@d1fe50798dbadd4eb5b98957290ca175f6b4870f # v4.0.2
        with:
          aqua_version: v2.53.7

      - name: Display PHP version info
        run: |
          echo "ğŸ˜ Testing PHP ${{ matrix.php-version }}"

      - name: Setup PHP
        uses: shivammathur/setup-php@ccf2c627fe61b1b4d924adfcbd19d661a18133a0 #v2.35.2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: pdo, pdo_sqlite, sqlite3
          tools: composer
          coverage: none
          ini-values: error_reporting=E_ALL&~E_DEPRECATED&~E_STRICT

      - name: Validate composer.json
        run: |
          echo "ğŸ” composer.jsonæ¤œè¨¼ä¸­..."

          # ã¾ãšåŸºæœ¬çš„ãªJSONã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯
          if ! php -r "json_decode(file_get_contents('composer.json'), true); if (json_last_error() !== JSON_ERROR_NONE) exit(1);"; then
            echo "âŒ composer.json contains invalid JSON"
            echo "ğŸ”§ composer.jsonã®æ§‹æ–‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            github-comment post -k common-error -var title:"composer.json contains invalid JSON (PHP: ${{ matrix.php-version }})" -var body:"composer.jsonã®æ§‹æ–‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            exit 1
          fi

          # Composer validationå®Ÿè¡Œ
          echo "ğŸ“‹ Composer validationå®Ÿè¡Œä¸­..."
          if ! composer validate --no-check-publish; then
            echo "âŒ composer.json validation failed"
            echo "ğŸ” è©³ç´°ãªè¨ºæ–­æƒ…å ±:"
            composer validate --verbose
            echo "ğŸ“‹ composer.json ã®å†…å®¹ç¢ºèª:"
            cat composer.json
            github-comment exec -k common-error -var title:"Check Validation composer.json Failed (PHP: ${{ matrix.php-version }})" -- composer validate --verbose
            exit 1
          fi
          echo "âœ… composer.json validation passed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 #4.2.3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ matrix.php-version }}-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-php-${{ matrix.php-version }}-

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing Composer dependencies..."
          composer install --prefer-dist --no-progress --no-interaction
          echo "âœ… Dependencies installed successfully"

      - name: Setup configuration file
        run: |
          echo "ğŸ”§ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Ÿè¡Œä¸­..."
          # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p data db config logs

          # config.php.exampleã®å­˜åœ¨ç¢ºèª
          if [ ! -f config/config.php.example ]; then
            echo "âŒ config/config.php.example ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            github-comment post -k common-error -var title:"'config/config.php.example' is not found (PHP: ${{ matrix.php-version }})" -var body:"'config/config.php.example' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # config.php.exampleã‹ã‚‰config.phpã‚’ä½œæˆ
          if [ ! -f config/config.php ]; then
            cp config/config.php.example config/config.php
            echo "âœ… config.php.exampleã‹ã‚‰config.phpã‚’ä½œæˆã—ã¾ã—ãŸ"
          fi

          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          echo "ğŸ“„ config.phpæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ä¸­..."
          if ! php -l config/config.php; then
            echo "âŒ config.phpã«æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"
            github-comment post -k common-error -var title:"Check 'config.php' Failed (PHP: ${{ matrix.php-version }})" -var body:"'config.php' ã«æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"
            exit 1
          fi
          echo "âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check PHP syntax
        run: |
          echo "ğŸ” PHPæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
          SYNTAX_ERRORS_COUNT=0
          SYNTAX_LOGS=""
          while IFS= read -r -d '' file; do
            echo "ğŸ“„ Checking: $file"
            SYNTAX_LOGS="$SYNTAX_LOGS\nğŸ“„ Checking: $file"
            if ! php -l "$file"; then
              echo "âŒ æ§‹æ–‡ã‚¨ãƒ©ãƒ¼: $file"
            SYNTAX_LOGS="$SYNTAX_LOGS\nâŒ æ§‹æ–‡ã‚¨ãƒ©ãƒ¼: $file"
              SYNTAX_ERRORS_COUNT=$((SYNTAX_ERRORS_COUNT + 1))
            fi
          done < <(find . -name "*.php" -not -path "./vendor/*" -print0)

          if [ $SYNTAX_ERRORS_COUNT -gt 0 ]; then
            echo "âŒ $SYNTAX_ERRORS_COUNT å€‹ã®PHPãƒ•ã‚¡ã‚¤ãƒ«ã«æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"
            SYNTAX_LOGS="$SYNTAX_LOGS\nâŒ $SYNTAX_ERRORS_COUNT å€‹ã®PHPãƒ•ã‚¡ã‚¤ãƒ«ã«æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"
            github-comment post -k common-error -var title:"Check PHP Syntax Failed (PHP: ${{ matrix.php-version }})" -var body:"$SYNTAX_LOGS"

            exit 1
          fi
          echo "âœ… PHPæ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº† - ã‚¨ãƒ©ãƒ¼ãªã—"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run PHP CodeSniffer
        run: |
          echo "ğŸ” PHP CodeSnifferå®Ÿè¡Œä¸­..."
          if [ -f "vendor/bin/phpcs" ]; then
            echo "ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ãƒã‚§ãƒƒã‚¯é–‹å§‹"
            # phpcs.xmlã‚’ä½¿ç”¨ã—ã¦ãƒã‚§ãƒƒã‚¯
            if ! vendor/bin/phpcs; then
              echo "âŒ ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„é•åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
              echo "ğŸ”§ ä¿®æ­£æ–¹æ³•: vendor/bin/phpcbf"
              echo "ğŸ“‹ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: phpcs.xml"
              github-comment exec -k common-error -var title:"Check PHP CodeSniffer Failed (PHP: ${{ matrix.php-version }})" -- vendor/bin/phpcs .
              exit 1
            fi
            echo "âœ… ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ãƒã‚§ãƒƒã‚¯å®Œäº†"
          else
            echo "âŒ PHPCS not installed..."
            github-comment post -k common-error -var title:"Check PHP CodeSniffer Failed (PHP: ${{ matrix.php-version }})" -var body:"PHPCS not installed..."
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run PHPStan
        run: |
          echo "ğŸ” PHPStané™çš„è§£æå®Ÿè¡Œä¸­..."
          if [ -f "vendor/bin/phpstan" ]; then
            echo "ğŸ“‹ é™çš„è§£æãƒã‚§ãƒƒã‚¯é–‹å§‹ (Level 1)"
            if ! vendor/bin/phpstan analyse --level=1 --no-progress .; then
              echo "âŒ é™çš„è§£æã§ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
              echo "ğŸ”§ è©³ç´°ã¯ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
              github-comment exec -k common-error -var title:"Check PHPStan Failed (PHP: ${{ matrix.php-version }})" -- vendor/bin/phpstan analyse --level=1 --no-progress
              exit 1
            fi
            echo "âœ… é™çš„è§£æãƒã‚§ãƒƒã‚¯å®Œäº†"
          else
            echo "âŒ PHPStan not installed..."
            github-comment post -k common-error -var title:"Check PHPStan Failed (PHP: ${{ matrix.php-version }})" -var body:"PHPStan not installed..."
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Test version synchronization
        run: |
          echo "ğŸ§ª ãƒãƒ¼ã‚¸ãƒ§ãƒ³åŒæœŸãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          php scripts/test-version.php || {
            echo "âš ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ç¶™ç¶šã—ã¾ã™"
            exit 0
          }

      - name: Run application tests
        run: |
          # åŸºæœ¬çš„ãªæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆå°†æ¥ã®PHPUnitç”¨ï¼‰
          echo "Basic functionality tests would run here"

      - name: Test Docker build
        run: |
          echo "ğŸ³ Dockerãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          docker build -t phpuploader-test ./docker/ || {
            echo "âš ï¸ Dockerãƒ“ãƒ«ãƒ‰ã«å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸãŒã€ç¶™ç¶šã—ã¾ã™"
            exit 0
          }
          echo "âœ… Dockerãƒ“ãƒ«ãƒ‰å®Œäº†"
