name: CI

on:
  pull_request:
    branches:
      - master
      - main

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    continue-on-error: ${{ matrix.php-version == '5.6' }}

    strategy:
      fail-fast: false
      matrix:
        php-version:
          - '7.4'
          - '8.0'
          - '8.1'
          - '8.2'
          - '8.3'

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Display PHP version info
        run: |
          echo "ğŸ˜ Testing PHP ${{ matrix.php-version }}"
          if [[ "${{ matrix.php-version }}" == "5.6" ]]; then
            echo "âš ï¸  Note: PHP 5.6 is legacy support - errors are non-blocking"
          fi

      - name: Setup PHP
        uses: shivammathur/setup-php@ccf2c627fe61b1b4d924adfcbd19d661a18133a0 #v2.35.2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: pdo, pdo_sqlite, sqlite3
          tools: ${{ matrix.php-version == '5.6' && 'none' || 'composer' }}
          coverage: none
          ini-values: error_reporting=E_ALL&~E_DEPRECATED&~E_STRICT

      - name: Validate composer.json
        run: |
          if [[ "${{ matrix.php-version }}" == "5.6" ]]; then
            echo "Skipping composer validate for PHP 5.6 (composer not installed)"
          else
            echo "ğŸ” Validating composer.json..."

            # ã¾ãšåŸºæœ¬çš„ãªJSONã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯
            if ! php -r "json_decode(file_get_contents('composer.json'), true); if (json_last_error() !== JSON_ERROR_NONE) exit(1);"; then
              echo "âŒ composer.json contains invalid JSON"
              exit 1
            fi

            # Composer validationå®Ÿè¡Œ
            composer validate --no-check-publish || {
              echo "âŒ composer.json validation failed"
              echo "ğŸ” è©³ç´°ãªè¨ºæ–­æƒ…å ±:"
              composer validate --verbose
              echo "ğŸ“‹ composer.json ã®å†…å®¹ç¢ºèª:"
              cat composer.json
              exit 1
            }
            echo "âœ… composer.json validation passed"
          fi

      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 #4.2.3
        if: matrix.php-version != '5.6'
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ matrix.php-version }}-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-php-${{ matrix.php-version }}-

      - name: Install dependencies
        run: |
          if [[ "${{ matrix.php-version }}" == "5.6" ]]; then
            echo "Skipping Composer install for PHP 5.6 (dev tools not compatible)"
          else
            echo "ğŸ“¦ Installing Composer dependencies..."
            composer install --prefer-dist --no-progress --no-interaction
            echo "âœ… Dependencies installed successfully"
          fi

      - name: Check PHP syntax
        run: |
          echo "ğŸ” PHPæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
          find . -name "*.php" -not -path "./vendor/*" -print0 | xargs -0 -n1 php -l
          if [ $? -ne 0 ]; then
            if [[ "${{ matrix.php-version }}" == "5.6" ]]; then
              echo "âš ï¸ PHP 5.6ã§æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ç¶™ç¶šã—ã¾ã™"
              exit 0
            else
              echo "âŒ PHPæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸ"
              exit 1
            fi
          fi
          echo "âœ… PHPæ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†"

      - name: Run PHP CodeSniffer
        run: |
          if [[ "${{ matrix.php-version }}" == "5.6" ]]; then
            echo "Skipping PHPCS for PHP 5.6 (not compatible)"
          elif [ -f "vendor/bin/phpcs" ]; then
            vendor/bin/phpcs --standard=PSR12 --ignore=vendor/ . || echo "âš ï¸ Coding standard violations found (non-blocking)"
          else
            echo "PHPCS not installed, skipping..."
          fi

      - name: Run PHPStan
        run: |
          if [[ "${{ matrix.php-version }}" == "5.6" ]]; then
            echo "Skipping PHPStan for PHP 5.6 (not compatible)"
          elif [ -f "vendor/bin/phpstan" ]; then
            vendor/bin/phpstan analyse --level=1 --no-progress . || echo "âš ï¸ Static analysis issues found (non-blocking)"
          else
            echo "PHPStan not installed, skipping..."
          fi

      - name: Test configuration file creation
        run: |
          # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p data db config
          # config.php.exampleã‹ã‚‰config.phpã‚’ä½œæˆ
          if [ ! -f config/config.php ]; then
            cp config/config.php.example config/config.php
            echo "âœ… config.php.exampleã‹ã‚‰config.phpã‚’ä½œæˆã—ã¾ã—ãŸ"
          fi
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          php -l config/config.php || {
            if [[ "${{ matrix.php-version }}" == "5.6" ]]; then
              echo "âš ï¸ PHP 5.6ã§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ãŒã€ç¶™ç¶šã—ã¾ã™"
              exit 0
            else
              echo "âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"
              exit 1
            fi
          }

      - name: Test version synchronization
        run: |
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³åŒæœŸãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
          if [[ "${{ matrix.php-version }}" != "5.6" ]]; then
            echo "ğŸ§ª ãƒãƒ¼ã‚¸ãƒ§ãƒ³åŒæœŸãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
            php scripts/test-version.php || {
              echo "âš ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ç¶™ç¶šã—ã¾ã™"
              exit 0
            }
          else
            echo "Skipping version test for PHP 5.6"
          fi

      - name: Run application tests
        run: |
          # åŸºæœ¬çš„ãªæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆå°†æ¥ã®PHPUnitç”¨ï¼‰
          echo "Basic functionality tests would run here"

      - name: Test Docker build
        run: |
          echo "ğŸ³ Dockerãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          docker build -t phpuploader-test ./docker/ || {
            echo "âš ï¸ Dockerãƒ“ãƒ«ãƒ‰ã«å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸãŒã€ç¶™ç¶šã—ã¾ã™"
            exit 0
          }
          echo "âœ… Dockerãƒ“ãƒ«ãƒ‰å®Œäº†"

  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup PHP
        uses: shivammathur/setup-php@ccf2c627fe61b1b4d924adfcbd19d661a18133a0 #v2.35.2
        with:
          php-version: '8.1'
          extensions: pdo, pdo_sqlite
          tools: composer

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Security audit
        run: |
          # Composerã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
          composer audit

      - name: Check for sensitive files
        run: |
          # æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
          if [ -f "config/config.php" ]; then
            echo "Error: config.php should not be committed"
            exit 1
          fi

          # .envãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
          if [ -f ".env" ]; then
            echo "Error: .env should not be committed"
            exit 1
          fi

          echo "âœ… No sensitive files found"

  documentation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 #v4.4.0
        with:
          node-version: '18'

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Lint README
        run: markdownlint README.md CHANGELOG.md --ignore node_modules --config .markdownlint.json

      - name: Check links in README
        uses: gaurav-nelson/github-action-markdown-link-check@3c3b66f1f7d0900e37b71eca45b63ea9eedfce31 #v1.10.17
        with:
          use-quiet-mode: 'yes'
